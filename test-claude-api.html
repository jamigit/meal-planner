n<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude API Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
        input { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Claude API Integration Test</h1>

    <div class="info status">
        <strong>Setup:</strong> Make sure you have a .env file with VITE_CLAUDE_API_KEY set to your Anthropic API key.
    </div>

    <div>
        <label for="apiKey">Claude API Key (or leave empty to use .env):</label>
        <input type="password" id="apiKey" placeholder="sk-ant-...">
    </div>

    <div>
        <label for="userNotes">Test User Notes:</label>
        <input type="text" id="userNotes" value="I want healthy meals this week" placeholder="User preferences...">
    </div>

    <button id="testBtn" onclick="testClaudeAPI()">Test Claude API</button>

    <div id="results"></div>

    <script type="module">
        // Mock the database services for testing
        window.mockMealHistoryService = {
            async categorizeRecipesByFrequency() {
                return {
                    regular: [
                        { id: '1', name: 'Chicken Stir Fry', tags: ['chicken', 'healthy'], frequency: 5 },
                        { id: '2', name: 'Fish Tacos', tags: ['fish', 'quick'], frequency: 3 }
                    ],
                    lessRegular: [
                        { id: '3', name: 'Vegetarian Pasta', tags: ['vegetarian', 'pasta'], frequency: 1 },
                        { id: '4', name: 'Turkey Meatballs', tags: ['turkey', 'protein'], frequency: 0 }
                    ]
                }
            },
            async getRecentMeals() {
                return [] // No recent meals to avoid
            }
        }

        window.mockRecipeService = {
            async getAll() {
                return [
                    { id: '1', name: 'Chicken Stir Fry', tags: ['chicken', 'healthy'], url: 'http://example.com/1' },
                    { id: '2', name: 'Fish Tacos', tags: ['fish', 'quick'], url: 'http://example.com/2' },
                    { id: '3', name: 'Vegetarian Pasta', tags: ['vegetarian', 'pasta'], url: 'http://example.com/3' },
                    { id: '4', name: 'Turkey Meatballs', tags: ['turkey', 'protein'], url: 'http://example.com/4' },
                    { id: '5', name: 'Salmon Bowl', tags: ['fish', 'healthy'], url: 'http://example.com/5' }
                ]
            }
        }

        // Create a test version of the Claude AI service
        class TestClaudeAiService {
            constructor(apiKey) {
                this.apiKey = apiKey
                this.apiUrl = 'https://api.anthropic.com/v1/messages'
                this.model = 'claude-3-5-sonnet-20241022'
                this.maxTokens = 1024
            }

            isConfigured() {
                return !!this.apiKey
            }

            filterByDietaryRestrictions(recipes) {
                return recipes.filter(recipe => {
                    const tags = recipe.tags?.map(tag => tag.toLowerCase()) || []
                    const hasGluten = tags.some(tag => tag.includes('gluten') && !tag.includes('free'))
                    const hasRedMeatOrPork = tags.some(tag =>
                        tag.includes('beef') || tag.includes('pork') || tag.includes('lamb') || tag.includes('steak')
                    )
                    return !hasGluten && !hasRedMeatOrPork
                })
            }

            createMealSuggestionPrompt(recipes, regularMeals, lessRegularMeals, recentMealIds, userNotes) {
                const recentMealNames = recipes
                    .filter(r => recentMealIds.includes(r.id))
                    .map(r => r.name)

                return `You are a meal planning assistant. Generate 3 different weekly meal suggestion sets based on the user's meal history and preferences.

**User's Recipe Collection:**
${recipes.map(r => `- ${r.name} (tags: ${r.tags?.join(', ') || 'none'})`).join('\n')}

**Meal Frequency Analysis (last 8 weeks):**
- Regular meals (eaten 3+ times): ${regularMeals.map(r => `${r.name} (${r.frequency}x)`).join(', ') || 'none'}
- Less regular meals (eaten 0-2 times): ${lessRegularMeals.map(r => `${r.name} (${r.frequency || 0}x)`).join(', ') || 'none'}
- Recently eaten (last 2 weeks - AVOID): ${recentMealNames.join(', ') || 'none'}

**Dietary Restrictions:**
- Must be gluten-free compatible
- No red meat or pork (chicken, fish, turkey, vegetarian OK)

**User Preferences for This Week:**
"${userNotes || 'No specific preferences'}"

**Requirements:**
1. Generate exactly 3 different suggestion sets
2. Each set should have exactly 4 meals
3. Each set should have 2 regular meals + 2 less regular meals (adjust if not enough available)
4. Avoid meals eaten in the last 2 weeks
5. Consider user preferences when selecting meals
6. Provide reasoning for each meal selection

**Response Format (JSON):**
{
  "suggestions": [
    {
      "set_number": 1,
      "explanation": "Overall explanation for this set's theme/approach",
      "meals": [
        {
          "recipe_name": "exact recipe name from collection",
          "reason": "why this meal was selected"
        }
      ]
    }
  ]
}

Generate diverse, personalized meal suggestions that balance the user's favorites with variety!`
            }

            async parseMealSuggestions(response, allRecipes) {
                try {
                    let jsonData
                    if (typeof response === 'string') {
                        const jsonMatch = response.match(/\{[\s\S]*\}/)
                        if (jsonMatch) {
                            jsonData = JSON.parse(jsonMatch[0])
                        } else {
                            throw new Error('No JSON found in response')
                        }
                    } else {
                        jsonData = response
                    }

                    const suggestions = []
                    for (const suggestion of jsonData.suggestions || []) {
                        const meals = []
                        for (const meal of suggestion.meals || []) {
                            const recipe = allRecipes.find(r =>
                                r.name.toLowerCase() === meal.recipe_name.toLowerCase()
                            )
                            if (recipe) {
                                meals.push({
                                    recipe,
                                    reason: meal.reason
                                })
                            }
                        }
                        if (meals.length > 0) {
                            suggestions.push({
                                set_number: suggestion.set_number,
                                meals,
                                explanation: suggestion.explanation
                            })
                        }
                    }
                    return suggestions
                } catch (error) {
                    console.error('Failed to parse Claude response:', error)
                    throw new Error('Invalid response format from Claude API')
                }
            }

            async generateMealSuggestions(userNotes = '') {
                try {
                    if (!this.isConfigured()) {
                        throw new Error('Claude API key not configured')
                    }

                    const { regular, lessRegular } = await window.mockMealHistoryService.categorizeRecipesByFrequency()
                    const recentMealIds = await window.mockMealHistoryService.getRecentMeals(2)
                    const allRecipes = await window.mockRecipeService.getAll()

                    const validRecipes = this.filterByDietaryRestrictions(allRecipes)
                    const validRegular = this.filterByDietaryRestrictions(regular)
                        .filter(recipe => !recentMealIds.includes(recipe.id))
                    const validLessRegular = this.filterByDietaryRestrictions(lessRegular)
                        .filter(recipe => !recentMealIds.includes(recipe.id))

                    if (validRecipes.length === 0) {
                        throw new Error('No recipes available that meet dietary restrictions')
                    }

                    const prompt = this.createMealSuggestionPrompt(
                        validRecipes,
                        validRegular,
                        validLessRegular,
                        recentMealIds,
                        userNotes
                    )

                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': this.apiKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: this.model,
                            max_tokens: this.maxTokens,
                            messages: [
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ]
                        })
                    })

                    if (!response.ok) {
                        const errorData = await response.text()
                        throw new Error(`Claude API error: ${response.status} - ${errorData}`)
                    }

                    const data = await response.json()
                    const content = data.content?.[0]?.text

                    if (!content) {
                        throw new Error('No content received from Claude API')
                    }

                    const suggestions = await this.parseMealSuggestions(content, validRecipes)

                    if (suggestions.length === 0) {
                        throw new Error('Claude did not generate any valid suggestions')
                    }

                    return {
                        success: true,
                        data: suggestions,
                        metadata: {
                            totalRegular: validRegular.length,
                            totalLessRegular: validLessRegular.length,
                            recentMealsAvoided: recentMealIds.length,
                            userNotes: userNotes || 'No specific preferences',
                            provider: 'Claude API'
                        }
                    }

                } catch (error) {
                    console.error('Claude AI service error:', error)
                    return {
                        success: false,
                        error: error.message
                    }
                }
            }
        }

        window.testClaudeAPI = async function() {
            const resultsDiv = document.getElementById('results')
            const testBtn = document.getElementById('testBtn')
            const apiKey = document.getElementById('apiKey').value.trim()
            const userNotes = document.getElementById('userNotes').value.trim()

            testBtn.disabled = true
            resultsDiv.innerHTML = '<div class="info status">Testing Claude API...</div>'

            try {
                // Use provided API key or try to get from environment
                const effectiveApiKey = apiKey || import.meta.env?.VITE_CLAUDE_API_KEY

                if (!effectiveApiKey) {
                    throw new Error('No API key provided. Please enter your Claude API key or set VITE_CLAUDE_API_KEY in .env file.')
                }

                const service = new TestClaudeAiService(effectiveApiKey)
                const result = await service.generateMealSuggestions(userNotes)

                if (result.success) {
                    resultsDiv.innerHTML = `
                        <div class="success status">
                            <strong>✅ Claude API Test Successful!</strong><br>
                            Generated ${result.data.length} suggestion sets
                        </div>
                        <h3>Results:</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error status">
                            <strong>❌ Claude API Test Failed:</strong><br>
                            ${result.error}
                        </div>
                    `
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error status">
                        <strong>❌ Test Error:</strong><br>
                        ${error.message}
                    </div>
                `
            } finally {
                testBtn.disabled = false
            }
        }
    </script>
</body>
</html>